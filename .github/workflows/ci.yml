name: Build and Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
    
    - name: Cache Rust dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install Python dependencies
      run: pip install componentize-py
    
    - name: Build Python Skill Scanner
      run: |
        cd component-skill-scanner/
        componentize-py -d ../wit -w scanner-component componentize app -o ../skill-scanner.wasm
    
    - name: Build Host Runtime
      run: cargo build --release
    
    - name: Test Scanner Component
      run: |
        ls -lh skill-scanner.wasm
        ./target/release/wasm-sandbox scan skill-scanner.wasm --file examples/malicious-skills/safe_skill.py
        ./target/release/wasm-sandbox scan skill-scanner.wasm --file examples/malicious-skills/api_key_stealer.py